# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

[build-system]
requires = ["scikit-build-core>=0.10.0"]
build-backend = "scikit_build_core.build"

[project]
name = "tvm"
# Note: Call version.py to update the version before building the wheel
version = "0.24.dev0"
description = "Apache TVM: An End-to-End Deep Learning Compiler Stack"
readme = "README.md"
license = { text = "Apache-2.0" }
requires-python = ">=3.9"
authors = [{ name = "Apache TVM Community", email = "dev@tvm.apache.org" }]
keywords = ["machine learning", "compiler", "deep learning", "inference"]
classifiers = [
  "Development Status :: 4 - Beta",
  "Intended Audience :: Developers",
  "Intended Audience :: Education",
  "Intended Audience :: Science/Research",
  "License :: OSI Approved :: Apache Software License",
  "Programming Language :: Python :: 3",
  "Programming Language :: Python :: 3.9",
  "Programming Language :: Python :: 3.10",
  "Programming Language :: Python :: 3.11",
  "Programming Language :: Python :: 3.12",
  "Topic :: Scientific/Engineering :: Artificial Intelligence",
  "Topic :: Software Development :: Libraries :: Python Modules",
]
# Core dependencies - these are the minimum required for basic TVM functionality
dependencies = [
  "apache-tvm-ffi",
  "cloudpickle",
  "ml_dtypes",
  "numpy",
  "packaging",
  "psutil",
  "scipy",
  "tornado",
  "typing_extensions",
]

# Optional dependencies for different features
[project.optional-dependencies]
# Model importers
importer-coreml = ["coremltools"]
importer-keras = ["tensorflow", "tensorflow-estimator"]
importer-onnx = [
  "future",
  "onnx",
  "onnxoptimizer",
  "onnxruntime",
  "torch",
  "torchvision",
]
importer-pytorch = ["torch", "torchvision"]
importer-tensorflow = ["tensorflow", "tensorflow-estimator"]
importer-tflite = ["tflite"]
importer-paddle = ["paddlepaddle"]

# AutoTVM and autoscheduler
autotvm = ["xgboost"]
autoscheduler = ["xgboost"]

# Development and testing
dev = [
  "ruff",
  "mypy",
  "pre-commit",
  "pytest",
  "pytest-xdist",
  "pytest-cov",
  "pytest-mock",
  "pytest-benchmark",
  "pytest-timeout",
  "pytest-rerunfailures",
  "pytest-repeat",
]

# All optional dependencies (excluding dev)
all = [
  "coremltools",
  "tensorflow",
  "tensorflow-estimator",
  "future",
  "onnx",
  "onnxoptimizer",
  "onnxruntime",
  "torch",
  "torchvision",
  "tflite",
  "paddlepaddle",
  "xgboost",
]

[project.urls]
Homepage = "https://tvm.apache.org/"
Documentation = "https://tvm.apache.org/docs/"
Repository = "https://github.com/apache/tvm"
"Bug Tracker" = "https://github.com/apache/tvm/issues"

[tool.scikit-build]
# Point to the root CMakeLists.txt
cmake.source-dir = "."
cmake.build-type = "Release"

# Configure the wheel to be Python version-agnostic
wheel.py-api = "py3"

# Build configuration
build-dir = "build"

# CMake configuration - ensure proper installation paths
cmake.args = ["-DTVM_BUILD_PYTHON_MODULE=ON"]

# Wheel configuration
wheel.packages = ["python/tvm"]
wheel.install-dir = "tvm"

# Source distribution configuration
sdist.include = [
  # Build files
  "/CMakeLists.txt",
  "/pyproject.toml",
  "/cmake/**/*",
  "/  */*",

  # Source code
  "/src/**/*.cc",
  "/src/**/*.h",
  "/include/**/*.h",

  # Python source
  "/python/tvm/**/*.py",
  "/python/tvm/**/*.pyi",

  # Documentation and metadata
  "/docs/**/*",
  "/LICENSE",
  "/README.md",
  "/NOTICE",

  # Tests
  "/tests/**/*",
]

sdist.exclude = [
  "**/.git",
  "**/.github",
  "**/__pycache__",
  "**/*.pyc",
  "build",
  "dist",
  "**/3rdparty/*/docs",
  "**/3rdparty/*/media",
  "**/3rdparty/*/examples",
  "**/3rdparty/*/test",
]

# Logging
logging.level = "INFO"

[tool.pytest.ini_options]
testpaths = ["tests"]
addopts = "-v --tb=short"
python_files = ["test_*.py", "*_test.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]

[tool.ruff]
include = ["python/**/*.py", "tests/**/*.py", "docs/**/*.py"]
line-length = 100
indent-width = 4
target-version = "py39"
exclude = [
  "3rdparty",
  "build",
  "dist",
  ".venv",
  ".mypy_cache",
  ".ruff_cache",
  "node_modules",
]

[tool.ruff.lint]
select = [
  "E",   # pycodestyle errors, https://docs.astral.sh/ruff/rules/#pycodestyle-e-w
  "F",   # pyflakes, https://docs.astral.sh/ruff/rules/#pyflakes-f
  "I",   # isort, https://docs.astral.sh/ruff/rules/#isort-i
  "UP",  # pyupgrade, https://docs.astral.sh/ruff/rules/#pyupgrade-up
  "RUF", # ruff, https://docs.astral.sh/ruff/rules/#ruff-specific-rules-ruf
]
ignore = [
  "E101",   # mixed-spaces-and-tabs (legacy code)
  "E402",   # module-import-not-at-top-of-file
  "E501",   # line-too-long (let ruff-format handle soft wrapping)
  "E711",   # none-comparison
  "E712",   # true-false-comparison
  "E721",   # type-comparison
  "E731",   # lambda-assignment (common pattern in TVM)
  "E741",   # ambiguous-variable-name (common in math-heavy code)
  "F401",   # unused-import (too many false positives with __init__.py re-exports)
  "F402",   # import-shadowed-by-loop-var
  "F403",   # undefined-local-with-import-star
  "F405",   # undefined-local-with-import-star-usage
  "F601",   # multi-value-repeated-key-literal
  "F811",   # redefined-while-unused
  "F821",   # undefined-name (false positives from star imports)
  "F841",   # unused-variable (too many in test code)
  "UP006",  # non-pep585-annotation (requires Python 3.9+ everywhere)
  "UP007",  # non-pep604-annotation-union
  "UP028",  # yield-in-for-loop
  "UP030",  # format-literals
  "UP031",  # printf-string-formatting
  "UP035",  # deprecated-import (typing compat)
  "RUF002", # ambiguous-unicode-character-docstring
  "RUF003", # ambiguous-unicode-character-comment
  "RUF005", # collection-literal-concatenation
  "RUF012", # mutable-class-default
  "RUF013", # implicit-optional
  "RUF015", # unnecessary-iterable-allocation-for-first-element
  "RUF017", # quadratic-list-summation
  "RUF022", # unsorted-dunder-all
  "RUF028", # invalid-formatter-suppression-comment
  "RUF043", # pytest-raises-ambiguous-pattern
  "RUF046", # unnecessary-cast-to-int
  "RUF059", # unused-unpacked-variable
  "E722",   # bare-except
  "UP022",  # replace-stdout-stderr
]
fixable = ["ALL"]
unfixable = []

[tool.ruff.lint.per-file-ignores]
"__init__.py" = ["F401"] # pyflakes: unused-import

[tool.ruff.lint.isort]
known-first-party = ["tvm"]

[tool.ruff.format]
quote-style = "double"
indent-style = "space"
skip-magic-trailing-comma = false
line-ending = "auto"
docstring-code-format = false
docstring-code-line-length = "dynamic"

[tool.mypy]
python_version = "3.9"
show_error_codes = true
mypy_path = ["python"]
files = ["python/tvm"]
namespace_packages = true
explicit_package_bases = true
allow_redefinition = true
ignore_missing_imports = true
follow_imports = "skip"
strict_optional = false
exclude = '''(?x)(
    ^\.venv/|
    ^build/|
    ^dist/|
    ^\.mypy_cache/|
    ^3rdparty/
)'''

[[tool.mypy.overrides]]
module = ["python.tvm.auto_scheduler.*"]
ignore_errors = true

[[tool.mypy.overrides]]
module = ["python.tvm.runtime.*"]
ignore_errors = true
